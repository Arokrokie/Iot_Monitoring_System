{% extends 'sensors/base.html' %}

{% block page_title %}Analytics{% endblock %}

{% block content %}
<!-- Statistics Overview -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-database fa-2x mb-2"></i>
                <div class="metric-value">{{ total_readings }}</div>
                <div class="small">Total Readings</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-microchip fa-2x mb-2"></i>
                <div class="metric-value">{{ device_count }}</div>
                <div class="small">Active Devices</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <div class="metric-value">{{ avg_interval }}min</div>
                <div class="small">Avg Interval</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-calendar-day fa-2x mb-2"></i>
                <div class="metric-value">{{ today_readings }}</div>
                <div class="small">Today's Readings</div>
            </div>
        </div>
    </div>
</div>

<!-- Temperature Analytics -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-thermometer-half"></i> Temperature Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="border-end">
                            <h4 class="text-primary">{{ temp_stats.avg|floatformat:1 }}°C</h4>
                            <small class="text-muted">Average</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border-end">
                            <h4 class="text-success">{{ temp_stats.min|floatformat:1 }}°C</h4>
                            <small class="text-muted">Minimum</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <h4 class="text-danger">{{ temp_stats.max|floatformat:1 }}°C</h4>
                        <small class="text-muted">Maximum</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tint"></i> Humidity Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="border-end">
                            <h4 class="text-primary">{{ humidity_stats.avg|floatformat:1 }}%</h4>
                            <small class="text-muted">Average</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border-end">
                            <h4 class="text-success">{{ humidity_stats.min|floatformat:1 }}%</h4>
                            <small class="text-muted">Minimum</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <h4 class="text-danger">{{ humidity_stats.max|floatformat:1 }}%</h4>
                        <small class="text-muted">Maximum</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Daily Readings</h5>
            </div>
            <div class="card-body">
                <canvas id="dailyChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Temperature Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="tempDistributionChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Activity Heatmap -->
<!-- Combined Temperature & Humidity Timeseries -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-wave-square"></i> Temperature & Humidity (last 24h)</h5>
            </div>
            <div class="card-body">
                {{ temp_series|json_script:"tempSeries" }}
                {{ temp_labels|json_script:"tempLabels" }}
                {{ humidity_series|json_script:"humiditySeries" }}
                {{ humidity_labels|json_script:"humidityLabels" }}
                <div class="chart-container" style="min-height:260px;">
                    <canvas id="combinedTempHumChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Battery & Motion Analytics -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-battery-half"></i> Battery Health Status</h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="border-end">
                            <h4 class="text-success mb-1">{{ battery_stats.high|default:"0" }}</h4>
                            <small class="text-muted">Good (>3.5V)</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border-end">
                            <h4 class="text-warning mb-1">{{ battery_stats.medium|default:"0" }}</h4>
                            <small class="text-muted">Low (3.0-3.5V)</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <h4 class="text-danger mb-1">{{ battery_stats.critical|default:"0" }}</h4>
                        <small class="text-muted">Critical (<3.0V)</small>
                    </div>
                </div>
                <div class="mt-auto">
                    <canvas id="batteryChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-running"></i> Motion Activity Summary</h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="border-end">
                            <h4 class="text-primary mb-1">{{ motion_stats.total|default:"0" }}</h4>
                            <small class="text-muted">Total Events</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border-end">
                            <h4 class="text-info mb-1">{{ motion_stats.avg_per_hour|default:"0" }}</h4>
                            <small class="text-muted">Avg/Hour</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <h4 class="text-success mb-1">{{ motion_stats.peak_hour|default:"--" }}</h4>
                        <small class="text-muted">Peak Hour</small>
                    </div>
                </div>
                <div class="mt-auto">
                    <canvas id="motionChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ daily_labels|json_script:"dailyLabels" }}
{{ daily_data|json_script:"dailyData" }}
{{ temp_distribution_labels|json_script:"tempDistLabels" }}
{{ temp_distribution_data|json_script:"tempDistData" }}
{{ battery_hour_labels|json_script:"batteryHourLabels" }}
{{ battery_hour_values|json_script:"batteryHourValues" }}
{{ motion_hour_values|json_script:"motionHourValues" }}
{{ motion_hour_labels|json_script:"motionHourLabels" }}

<script>
// Daily readings chart
const dailyCtx = document.getElementById('dailyChart').getContext('2d');
const dailyLabels = JSON.parse(document.getElementById('dailyLabels').textContent || '[]');
const dailyData = JSON.parse(document.getElementById('dailyData').textContent || '[]');
new Chart(dailyCtx, {
    type: 'bar',
    data: {
        labels: dailyLabels,
        datasets: [{
            label: 'Readings',
            data: dailyData,
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// Temperature distribution chart
const tempDistributionCtx = document.getElementById('tempDistributionChart').getContext('2d');
const tempDistLabels = JSON.parse(document.getElementById('tempDistLabels').textContent || '[]');
const tempDistData = JSON.parse(document.getElementById('tempDistData').textContent || '[]');
new Chart(tempDistributionCtx, {
    type: 'bar',
    data: {
        labels: tempDistLabels,
        datasets: [{
            label: 'Temperature Range (°C)',
            data: tempDistData,
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ],
            borderColor: '#fff',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { beginAtZero: true }
        },
        plugins: {
            legend: { display: false }
        }
    }
});

// Battery chart (hourly averages last 24h)
const batteryCtx = document.getElementById('batteryChart').getContext('2d');
const batteryHourLabels = JSON.parse(document.getElementById('batteryHourLabels').textContent || '[]');
const batteryHourValues = JSON.parse(document.getElementById('batteryHourValues').textContent || '[]');
new Chart(batteryCtx, {
    type: 'line',
    data: {
        labels: batteryHourLabels,
        datasets: [{
            label: 'Avg Battery Voltage (V)',
            data: batteryHourValues,
            borderColor: '#FFA500',
            backgroundColor: 'rgba(255, 165, 0, 0.12)',
            tension: 0.3,
            spanGaps: true,
            pointRadius: 2,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { beginAtZero: false, title: { display: true, text: 'Voltage (V)' } }
        }
    }
});

// Motion chart (hourly sums last 24h)
const motionCtx = document.getElementById('motionChart').getContext('2d');
const motionHourLabels = JSON.parse(document.getElementById('motionHourLabels').textContent || '[]');
const motionHourValues = JSON.parse(document.getElementById('motionHourValues').textContent || '[]');
new Chart(motionCtx, {
    type: 'bar',
    data: {
        labels: motionHourLabels,
        datasets: [{
            label: 'Motion Events',
            data: motionHourValues,
            backgroundColor: 'rgba(75, 192, 192, 0.9)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Events' } }
        }
    }
});

// Combined Temperature & Humidity chart (last 24h)
const tempSeries = JSON.parse(document.getElementById('tempSeries').textContent || '[]');
const tempLabelsParsed = JSON.parse(document.getElementById('tempLabels').textContent || '[]');
const humiditySeries = JSON.parse(document.getElementById('humiditySeries').textContent || '[]');
const humidityLabelsParsed = JSON.parse(document.getElementById('humidityLabels').textContent || '[]');
// Prefer using tempLabelsParsed as the x-axis. If humidity has different timestamps, we align by index.
const combinedCtx = document.getElementById('combinedTempHumChart').getContext('2d');
new Chart(combinedCtx, {
    type: 'line',
    data: {
        labels: tempLabelsParsed,
        datasets: [
            {
                label: 'Temperature (°C)',
                data: tempSeries,
                yAxisID: 'yTemp',
                borderColor: '#FF6384',
                backgroundColor: 'rgba(255,99,132,0.1)',
                tension: 0.2,
                pointRadius: 2,
            },
            {
                label: 'Humidity (%)',
                data: humiditySeries,
                yAxisID: 'yHum',
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54,162,235,0.05)',
                tension: 0.2,
                pointRadius: 2,
            },
        ],
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        scales: {
            yTemp: {
                type: 'linear',
                position: 'left',
                title: { display: true, text: 'Temperature (°C)' },
            },
            yHum: {
                type: 'linear',
                position: 'right',
                title: { display: true, text: 'Humidity (%)' },
                grid: { drawOnChartArea: false },
            },
            x: { display: true },
        },
    },
});
</script>
{% endblock %}
